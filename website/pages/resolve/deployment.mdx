import { Callout } from "nextra/components";
import { Steps } from "nextra/components";

# Resolve Deployment

This page will guide you through getting Resolve deployed in a Virtual Machine (VM).

## Prerequisites

- A VM up and running with below apps:
  - Installed [Docker](https://knowledgebase.aridhia.io/workspaces/analysing-data/virtual-machines/installing-software-on-virtual-machines/installing-docker-on-your-virtual-machine) and [Docker Compose](https://docs.docker.com/compose/install/)
  - Installed [wget](https://phoenixnap.com/kb/wget-command-with-examples#:~:text=wget%20is%20a%20free%20GNU,this%20tutorial%20uses%20Ubuntu%2022.04)
- A OMOP CDM database server up and running

## Deployment Steps

### Get the example Compose file

Download the example of Resolve's Compose file by running the command:

```bash copy
wget https://github.com/Health-Informatics-UoN/hutch/blob/main/samples/Bunny/compose.resolve.yml
```

### Environment configuration

Modify the configs of the newly downloaded Compose file following the below reference:

#### Database

You need to change the `DATASOURCE_DB_HOST` value according to your actual database host. Also modify other configs about Database if needed.

```yaml
- DATASOURCE_DB_USERNAME=postgres
- DATASOURCE_DB_PASSWORD=postgres
- DATASOURCE_DB_DATABASE=postgres
- DATASOURCE_DB_DRIVERNAME=postgresql
- DATASOURCE_DB_SCHEMA=public
- DATASOURCE_DB_PORT=5432
- DATASOURCE_DB_HOST=db_host
```

#### Client Task API

- You need to change the `TASK_API_BASE_URL` value according to your actual task API host where Resolve connected to `GET` the job and `POST` the results back.
- The I/O requests from Resolve are authenticated by the `TASK_API_USERNAME` and `TASK_API_PASSWORD`, please put your Task API credentials here

```yaml
- TASK_API_BASE_URL=task_api_host
- TASK_API_USERNAME=username
- TASK_API_PASSWORD=password
```

#### Obfuscation

Below are the settings for obfuscation. More details about these can be found [here](/hutch/resolve/config). Please change this to fit your obfuscation preferences.

```yaml
- LOW_NUMBER_SUPPRESSION_THRESHOLD=
- ROUNDING_TARGET=
```

#### Polling

By default, Resolve will make `GET` request to Task API host every 5 seconds to check for jobs. You can change this setting by put a number here.

```yaml
- POLLING_INTERVAL=5
```

#### Collection ID

This is the collection ID you would like to query.

```yaml
- COLLECTION_ID=collection_id
```

After setting environment configuration, you are ready to run Resolve on your VM.

## Running Resolve

At the downloaded Compose.yml directory, run the command to activate Resolve:

```bash copy
docker compose up
```

You should then see a message in your console like this:

```bash
INFO - 12-Nov-24 12:36:24 - Setting up database connection...
INFO - 12-Nov-24 12:36:24 - Looking for job...
INFO - 12-Nov-24 12:36:29 - Job received. Resolving...
INFO - 12-Nov-24 12:36:29 - Processing query...
INFO - 12-Nov-24 12:36:30 - Solved availability query
INFO - 12-Nov-24 12:36:30 - Job resolved.
INFO - 12-Nov-24 12:36:35 - Looking for job...
INFO - 12-Nov-24 12:36:40 - Looking for job...
INFO - 12-Nov-24 12:36:45 - Looking for job...
```

Resolve establishes a connection to your OMOP-CDM database, then polls the Task API Host for a job.
When it receives a job, it processes the query, queries the database, and sends the result back to Task API Host.
You won't see the results here, but if you see the messages, then it's successfully contacting both the database and Task API Host.

<Callout emoji="ðŸŽ‰">Congratulations on your first Resolve deployment!</Callout>
