import { Callout, Tabs, Table, Td, Th, Tr, Code } from "nextra/components";
import { Steps } from "nextra/components";

# Getting started with Bunny

This page will guide you through getting a Bunny developer environment locally.

Start by cloning [the Bunny repository](https://github.com/Health-Informatics-UoN/hutch-bunny)

## Prerequisites

- Bunny runs on Python version 3.13
- Dependencies are managed with [uv](https://github.com/astral-sh/uv).
- A [OMOP CDM](omop-cdm) database

## Environment configuration

To run Bunny locally, your environment needs to have some variables configured.

<Steps>
### Create a file called .env in the repository root.
The file should contain the variables required to connect to a database and Task API.

For example, if using the containerized Relay and local database:

```sh copy
DATASOURCE_DB_USERNAME=postgres
DATASOURCE_DB_PASSWORD=postgres
DATASOURCE_DB_DATABASE=postgres
DATASOURCE_DB_DRIVERNAME=postgresql
DATASOURCE_DB_SCHEMA=public
DATASOURCE_DB_PORT=5432
DATASOURCE_DB_HOST=localhost
TASK_API_BASE_URL=http://localhost:8080
TASK_API_USERNAME=username
TASK_API_PASSWORD=password
LOW_NUMBER_SUPPRESSION_THRESHOLD=
ROUNDING_TARGET=
POLLING_INTERVAL=5
```

If you are querying a remote database, the variables prefixed with `DATASOURCE` must be configured accordingly.
If you use another method to set your environment variables, follow the example above and [configuration](/bunny/config) documentation.

</Steps>
## Installing dependencies
The first time you run Bunny outside a container, you will need to install its dependencies by running
```bash copy
uv sync
```

## Running the Docker daemon

Bunny has a daemon which polls a upstream Task API for tasks, so needs to have a Relay or RQUEST instance running.

<Steps>
### Start the Relay container

The compose used to start up the database also contains an implementation of Relay.

```bash copy
docker compose up relay -d
```

### Run the Bunny daemon

The Bunny daemon can then be run using uv. This will ensure the dependencies and environment variables are loaded.

```bash copy
uv run bunny-daemon
```

You should then see a message in your console like this:

```bash
INFO - 12-Nov-24 12:36:24 - Setting up database connection...
INFO - 12-Nov-24 12:36:24 - Looking for job...
INFO - 12-Nov-24 12:36:29 - Job received. Resolving...
INFO - 12-Nov-24 12:36:29 - Processing query...
INFO - 12-Nov-24 12:36:30 - Solved availability query
INFO - 12-Nov-24 12:36:30 - Job resolved.
INFO - 12-Nov-24 12:36:35 - Looking for job...
INFO - 12-Nov-24 12:36:40 - Looking for job...
INFO - 12-Nov-24 12:36:45 - Looking for job...
```

Bunny establishes a connection to your OMOP-CDM database, then polls Relay for a job.
When it receives a job, it processes the query, queries the database, and sends the result back to Relay.
You won't see the results here, but if you see the messages, then it's successfully contacting both the database and Relay.

</Steps>

<Callout emoji="ðŸŽ‰">Congratulations on your first Bunny query!</Callout>

## Running bunny-cli

To run Bunny without Relay, the command-line interface can be used.
This needs a file with the right JSON schema to run (example below).

### How to run

<Tabs items={['Docker', 'From Source']}>
  <Tabs.Tab>
    You will need to have made the input file available to the docker container, for example by mounting a volume.

    It is possible to pass Docker arguments to `docker run` **before** the image, and arguments to the Bunny CLI **after** the image.

    Here's an example with `docker run`:

    ```bash copy
    docker run \
    -v <path/to/rquest-query.json>:./rquest-query.json \
    --entrypoint uv \
    ghcr.io/health-informatics-uon/hutch/bunny:<TAG> \
    run bunny --body ./rquest-query.json
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    To run the CLI, from root run

    ```bash copy
    uv run bunny --body <path/to/rquest-query.json>
    ```

    This should write a result for your query to `app/bunny/output.json`

  </Tabs.Tab>
</Tabs>

### Sample input files

```json copy filename="availability.json"
{
  "task_id": "job-2023-01-13-14: 20: 38-project",
  "project": "project_id",
  "owner": "user1",
  "cohort": {
    "groups": [
      {
        "rules": [
          {
            "varname": "OMOP",
            "varcat": "Person",
            "type": "TEXT",
            "oper": "=",
            "value": "8507"
          }
        ],
        "rules_oper": "AND"
      }
    ],
    "groups_oper": "OR"
  },
  "collection": "collection_id",
  "protocol_version": "v2",
  "char_salt": "salt",
  "uuid": "unique_id"
}
```
