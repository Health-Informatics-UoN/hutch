import { Callout, Tabs, Table, Td, Th, Tr, Code } from "nextra/components";
import { Mandatory } from "../../components/Mandatory";

# Configuration

Relay can be configured using environment variables, or any approach supported by [ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/)

Your desired approach may differ depending on the environment you're configuring, e.g.:

<Tabs items={['Compose Container Stack', 'Local Development']}>
  <Tabs.Tab>
    If you're running Relay as part of a composed stack of containers, we recommend setting environment variables in the `compose.yml`.
    
    For example:

    ```yaml filename="compose.yml"
    services:
      # ...

      relay:
        # ...

        environment:
          ConnectionStrings__Default: Server=db_host;Port=5432;Database=hutch-relay;User Id=postgres;Password=postgres
          RelayTaskQueue__ConnectionString: amqp://user:password@rabbitmq:5672

          UpstreamTaskApi__BaseUrl: https://my-task-api.com
          UpstreamTaskApi__CollectionId: dd52026b-5a61-4c89-b733-04ba141b3f31
          UpstreamTaskApi__Username: user
          UpstreamTaskApi__Password: password

        # ...
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    In development, you should use [.NET User Secrets](https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets), and run Relay with `DOTNET_Environment` set to `Development`.

    <Callout emoji="ðŸ’¡">
      Running from an IDE will set the environment to `Development` for you, and
      provide a way to edit User Secrets.
    </Callout>

    ```json filename="secrets.json"
    {
      "ConnectionStrings": {
        "Default": "Server=localhost;Port=5432;Database=hutch-relay;User Id=postgres;Password=postgres"
      },
      "RelayTaskQueue": {
        "ConnectionString": "amqp://user:password@localhost:5672"
      },
      "UpstreamTaskApi": {
        "Enable": true,
        "BaseUrl": "https://my-task-api.com",
        "CollectionId": "dd52026b-5a61-4c89-b733-04ba141b3f31",
        "Username": "user",
        "Password": "password"
      }
    }
    ```

  </Tabs.Tab>
</Tabs>

## Upstream Task API [#upstream-task-api]

**Configuration Section: `UptreamTaskApi`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`Enable`</Td>
      <Td>
        Whether to enable [Upstream Task Api](/relay/features/query-sources/upstream-task-api) functionality: `true|false`

        When set to false, the following occur:

        - All other `UpstreamTaskApi` configuration is not required
        - The background polling service which polls the Upstream Task API for jobs will not start.
        - When Relay receives results from downstream clients, it will not submit them to an Upstream Task API.

        Defaults to `true`.
      </Td>
    </Tr>
    <Tr>
      <Td>
        <Mandatory>`BaseUrl`</Mandatory>
      </Td>
      <Td>
        The Base URL for an Upstream Task API that Relay should fetch jobs from.
        This only needs to include scheme (e.g. `https://`), host
        (`my-task-api.com`) and optionally port `8080`
      </Td>
    </Tr>
    <Tr>
      <Td>
        <Mandatory>`CollectionId`</Mandatory>
      </Td>
      <Td>An ID (provided from the Upstream API) for this Task API consumer</Td>
    </Tr>
    <Tr>
      <Td>
        <Mandatory>`Username`</Mandatory>
      </Td>
      <Td>A valid username for accessing the Task API</Td>
    </Tr>
    <Tr>
      <Td>
        <Mandatory>`Password`</Mandatory>
      </Td>
      <Td>A valid password for the Task API user configured above</Td>
    </Tr>
    <Tr>
      <Td>`PollingFrequency`</Td>
      <Td>
        Interval in milliseconds between polling requests to the Upstream Task
        API.

        Defaults to `5000` (5 seconds).
      </Td>
    </Tr>
    <Tr>
      <Td>`ResumeOnError`</Td>
      <Td>
        Whether to resume polling after a non-critical error occurs, swallowing (but logging) the exception.

        Container orchestrated (k8s, compose) or systemd service environments should prefer to always terminate,
        and control restarting the application themselves.

        Defaults to `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`ErrorDelay`</Td>
      <Td>
        The delay in seconds to wait before resuming polling after an error occurs.

        Defaults to `5`.
      </Td>
    </Tr>
    <Tr>
      <Td>`QueueTypes`</Td>
      <Td>
        Specify which Job Type queues Relay should poll against in the Upstream Task API.

        Can be an empty string, a `*`, or a list of comma separated Task API Job Type codes.
        An empty string will cause Relay to poll single "unified" queue for jobs of any type, e.g. when connecting to Upstream Relays.
        A comma separated list will cause Relay to poll separate queues for each supported type listed, in parallel, e.g. when connecting to upstream RQUEST.

        Defaults to `*` polling all supported types from separate queues (standard RQUEST behaviour)
      </Td>
    </Tr>

  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    UpstreamTaskApi__BaseUrl="https://my-task-api.com"
    UpstreamTaskApi__CollectionId="dd52026b-5a61-4c89-b733-04ba141b3f31"
    UpstreamTaskApi__Username=user
    UpstreamTaskApi__Password=password
    UpstreamTaskApi__PollingFrequency=5000
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      UpstreamTaskApi__BaseUrl: https://my-task-api.com
      UpstreamTaskApi__CollectionId: dd52026b-5a61-4c89-b733-04ba141b3f31
      UpstreamTaskApi__Username: user
      UpstreamTaskApi__Password: password
      UpstreamTaskApi__PollingFrequency: 5000
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "UpstreamTaskApi": {
        "BaseUrl": "https://my-task-api.com",
        "CollectionId": "dd52026b-5a61-4c89-b733-04ba141b3f31",
        "Username": "user",
        "Password": "password"
        "PollingFrequency": 5000
      }
    }
    ```

  </Tabs.Tab>
</Tabs>

## GA4GH Beacon [#GA4GH-Beacon]

**Configuration Section: `Beacon`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`Enable`</Td>
      <Td>
        Whether to enable Beacon functionality: `true|false`

        Defaults to `false`
      </Td>
    </Tr>
    <Tr>
      <Td>`RequestFilteringTermsOnStartup`</Td>
      <Td>
        Whether to request filtering terms from subnodes when Relay starts.

        - `Never`: do not queue Generic Code Distribution tasks at Startup
        - `IfEmpty`: if there are no cached terms at startup, then queue Generic Code Distribution tasks if there aren't any already in progress.
        - `ForceIfEmpty`: if there are no cached terms at startup, then queue Generic Code Distribution tasks EVEN IF there ARE some already in progress.
        - `Always`: Regardless of the state of the cache, queue Generic Code Distribution tasks if there aren't any already in progress.
        - `ForceAlways`: Regardless of the state of the cache, queue Generic Code Distribution tasks EVEN IF there ARE some already in progress.

        Default `Never`.
      </Td>
    </Tr>

  </tbody>
</Table>

**Configuration Section: `Beacon.SecurityAttributes`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`DefaultGranularity`</Td>
      <Td>
        [Default Granularity](https://b2ri-documentation.readthedocs.io/en/latest/api/#granularity) for Relay's Beacon functionality.

        - `boolean`
        - `count`

        Defaults to `boolean`
      </Td>
    </Tr>
    <Tr>
      <Td>`SecurityLevels`</Td>
      <Td>
        [Security Level](https://b2ri-documentation.readthedocs.io/en/latest/api/#api-security-levels) for Relay's Beacon functionality.

        Only `PUBLIC` is currently supported by Relay.

        Defaults to `PUBLIC`
      </Td>
    </Tr>

  </tbody>
</Table>

**Configuration Section: `Beacon.MaturityAttributes`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`ProductionStatus`</Td>
      <Td>
        Production Status for Relay's Beacon functionality.

        - `DEV`
        - `TEST`
        - `PROD`

        Defaults to `DEV`
      </Td>
    </Tr>

  </tbody>
</Table>

**Configuration Section: `Beacon.Info`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`Id`</Td>
      <Td>
        A unique identifier for this Beacon installation.

        Values should typically be in reverse domain notation e.g. `org.my-organization.beacon`

        Default is empty.
      </Td>
    </Tr>
    <Tr>
      <Td>`Name`</Td>
      <Td>
        A friendly name for this Beacon installation.

        Defaults to `Hutch Relay Beacon`
      </Td>
    </Tr>
    <Tr>
      <Td>`Description`</Td>
      <Td>
        Description of this Beacon installation.

        Defaults to `A federated discovery service for aggregate individuals summaries across multiple downstream data sources`
      </Td>
    </Tr>
    <Tr>
      <Td>`BeaconOrganization`</Td>
      <Td>Details of the organisation responsible for this Beacon installation.</Td>
    </Tr>
    <Tr>
      <Td>`WelcomeUrl`</Td>
      <Td>
        Link to a web page for this Beacon installation.
      </Td>
    </Tr>
    <Tr>
      <Td>`AlternativeUrl`</Td>
      <Td>
        Another URL where this Beacon may be accessed; possibly with other restrictions in place.
      </Td>
    </Tr>
    <Tr>
      <Td>`CreatedDate`</Td>
      <Td>
        The ISO-8601 date/time this Beacon installation was made available.
        
        Defaults to when Beacon functionality was made available in Relay.
      </Td>
    </Tr>
    <Tr>
      <Td>`UpdatedDate`</Td>
      <Td>
        The ISO-8601 date/time this Beacon installation was last updated.
        
        Defaults to the Build timestamp of the running release of Relay.
      </Td>
    </Tr>

  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    Beacon__Enable=true
    Beacon__RequestFilteringTermsOnStartup="IfEmpty"
    Beacon__SecurityAttributes__DefaultGranularity="count"
    Beacon__MaturityAttributes__ProductionStatus="PROD"
    Beacon__Info__Id="org.my-organization.beacon"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      Beacon__Enable: true
      Beacon__RequestFilteringTermsOnStartup: "IfEmpty"
      Beacon__SecurityAttributes__DefaultGranularity: "count"
      Beacon__MaturityAttributes__ProductionStatus: "PROD"
      Beacon__Info__Id: "org.my-organization.beacon"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "Beacon": {
        "Enable": "true",
        "RequestFilteringTermsOnStartup": "IfEmpty",
        "SecurityAttributes": {
          "DefaultGranularity": "count"
        },
        "MaturityAttributes": {
          "ProductionStatus": "PROD"
        },
        "Info": {
          "Id": "org.my-organization.beacon"
        }
      }
    }
    ```

  </Tabs.Tab>
</Tabs>

## Database Connections [#database]

**Configuration Section: `ConnectionStrings`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>
        <Mandatory>`Default`</Mandatory>
      </Td>
      <Td>
        An ODBC/ADO.NET style connection string for a PostgreSQL 16 Server, and
        a database name for Relay to store working state in.
      </Td>
    </Tr>
  </tbody>
</Table>

**Configuration Section: `Database`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`ApplyMigrationsOnStartup`</Td>
      <Td>
        Should Relay automatically apply outstanding database migrations at
        startup? `true` / `false`.
        
        Defaults to `false`.
      </Td>
    </Tr>
    <Tr>
      <Td>`RetainCompletedTaskState`</Td>
      <Td>
        Should Relay keep Task and SubTask records for completed Tasks (including results)? `true` / `false`.
        
        Defaults to `false`.
      </Td>
    </Tr>
  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON', 'Command Line']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    ConnectionStrings__Default="Server=localhost;Port=5432;Database=hutch-relay;User Id=postgres;Password=postgres"
    Database__ApplyMigrationsOnStartup=true
    Database__RetainCompletedTaskState=true
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      ConnectionStrings__Default: "Server=localhost;Port=5432;Database=hutch-relay;User Id=postgres;Password=postgres"
      Database__ApplyMigrationsOnStartup: true
      Database__RetainCompletedTaskState: true
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "ConnectionStrings": {
        "Default": "Server=localhost;Port=5432;Database=hutch-relay;User Id=postgres;Password=postgres"
      },
      "Database": {
        "ApplyMigrationsOnStartup": true,
        "RetainCompletedTaskState": true
      }
    }
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    Any Relay CLI command that connects to the database can have its connection string specified with the [`--connection-string` option](/relay/cli/global-options#--connection-string)

    ```bash copy
    --connection-string "Server=localhost;Port=5432;Database=hutch-relay;User Id=postgres;Password=postgres"
    ```
  </Tabs.Tab>
</Tabs>

## RelayTask Queue

**Configuration Section: `RelayTaskQueue`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>
        <Mandatory>`ConnectionString`</Mandatory>
      </Td>
      <Td>A connection URL for an AMQP Server</Td>
    </Tr>
  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    RelayTaskQueue__ConnectionString="amqp://user:password@localhost:5672"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      RelayTaskQueue__ConnectionString: "amqp://user:password@localhost:5672"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "RelayTaskQueue": {
        "ConnectionString": "amqp://user:password@localhost:5672"
      },
    }
    ```

  </Tabs.Tab>
</Tabs>

## Declarative State Configuration [#declarative-config]

Relay requires some local state to operate. This state can be managed imperatively via the [CLI](cli), or configured declaratively.

Declarative configuration means you can specify in a configuration file or Environment Variables the state you would like to exist when Relay runs, and Relay will ensure that desired declared state at startup before doing anything else.

This is good for Container Orchestration environments in particular, which favour a "desired state" model. Values could be provided via secret management mechanisms where appropriate.

<Callout>
Remember that declarative config is "desired state", NOT just data seeding; if you remove users or subnodes from config later, Relay will reconcile the local datastore with the config, removing unspecified items if they were previously declared!
</Callout>

#### Mixing declarative and imperative (CLI) config

The recommendation generally is to not mix approaches, however it is possible if necessary.

Declarative Config is compatible with imperatively configured state (i.e. added by CLI) and will not interfere with state added manually; it only enacts the desired state resolution on "declared" state.

- When Relay resolves Declarative Config, it will only amend state that is marked as coming from a declarative source.
  - i.e. it will ignore imperatively added state
- If you imperatively or manually modify declared state, it will be "corrected" the next time declared state is resolved.

### Downstream Users and Subnodes [#declarative-subnodes]

At minimum Relay requires at least one user and an associated subnode, to represent a downstream client and the credentials they use to interact with Relay.

<Callout>Users and Subnodes can alternatively be configured via the [users cli](cli/users), particularly `users add`.</Callout>

**Configuration Section: `DownstreamUsers.<username>`**

<Callout>
Note that for these configuration options, `DownstreamUsers` is a dictionary, and the keys are the desired username of each user.
</Callout>
<br />

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>
        <Mandatory>`Password`</Mandatory>
      </Td>
      <Td>The desired password for this user</Td>
    </Tr>
    <Tr>
      <Td>
        `Subnode`
      </Td>
      <Td>The ID to use when creating a subnode for this user (i.e. Collection ID). This *must* be a valid UUID format string.</Td>
    </Tr>
    <Tr>
      <Td>
        `Subnodes`
      </Td>
      <Td>An array of IDs to use when creating multiple subnodes for this user (i.e. Collection IDs). These *must* be a valid UUID format string.</Td>
    </Tr>
  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    # user with single subnode
    DownstreamUsers__user1__Password=abc123
    DownstreamUsers__user1__Subnode=93258ae6-472f-45d2-8cf9-8b64cbeb03c8

    # user with multiple subnodes
    DownstreamUsers__user2__Password=def456
    DownstreamUsers__user2__Subnodes__0=b8c58ab0-51c7-4842-ac96-efffc2c02472
    DownstreamUsers__user2__Subnodes__1=50401056-8d4a-44c7-a257-f57ab2dcfb01
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      # user with single subnode
      DownstreamUsers__user1__Password: abc123
      DownstreamUsers__user1__Subnode: "93258ae6-472f-45d2-8cf9-8b64cbeb03c8"

      # user with multiple subnodes
      DownstreamUsers__user2__Password: def456
      DownstreamUsers__user2__Subnodes__0: "b8c58ab0-51c7-4842-ac96-efffc2c02472"
      DownstreamUsers__user2__Subnodes__1: "50401056-8d4a-44c7-a257-f57ab2dcfb01"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "DownstreamUsers": {
        "user1": {
          "Password": "abc123",
          "Subnode": "93258ae6-472f-45d2-8cf9-8b64cbeb03c8"
        },
        "user2": {
          "Password": "def456",
          "Subnodes": [
            "b8c58ab0-51c7-4842-ac96-efffc2c02472",
            "50401056-8d4a-44c7-a257-f57ab2dcfb01"
          ]
        }
      }
    }
    ```

  </Tabs.Tab>
</Tabs>


## Results Obfuscation

**Configuration Section: `Obfuscation`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`LowNumberSuppressionThreshold`</Td>
      <Td>
        A positive number will set the threshold below which Relay will suppress
        and return `0`.

        Set to `0` to disable suppression.
        
        Defaults to `10`, so turning it off is an explicit action.
      </Td>
    </Tr>
    <Tr>
      <Td>`RoundingTarget`</Td>
      <Td>
        The target nearest number to round to.
        
        e.g. `10` will round
        - `170` - `174` down to `170`
        - `175` - `179` up to `180`

        Set to `0` to disable rounding.
        
        Defaults to `10`, so turning it off is an explicit action.
      </Td>
    </Tr>
  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    Obfuscation__LowNumberSuppressionThreshold=50
    Obfuscation__RoundingTarget=5
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      Obfuscation__LowNumberSuppressionThreshold: 50
      Obfuscation__RoundingTarget: 5
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "Obfuscation": {
        "LowNumberSuppressionThreshold": 50,
        "RoundingTarget": 5
      }
    }
    ```

  </Tabs.Tab>
</Tabs>

## Monitoring

**Configuration Section: `Monitoring`**

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`HealthEndpoint`</Td>
      <Td>
        The route to use for the health check endpoint.

        Defaults to `/healthz`.
      </Td>
    </Tr>
  </tbody>
</Table>

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    Monitoring__HealthEndpoint="/health"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      Monitoring__HealthEndpoint: "/health"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "Monitoring": {
        "HealthEndpoint": "/health",
      }
    }
    ```

  </Tabs.Tab>
</Tabs>

## Logging

**Configuration Section: `Serilog`**

Logging is implemented through [Serilog](https://github.com/serilog/serilog-extensions-logging).

Examples:

<Tabs items={['Environment', 'Compose', 'JSON']}>
  <Tabs.Tab>
    ```bash filename=".env" copy
    Serilog__MinimumLevel__Default="Information"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="compose.yml" copy
    environment:
      Serilog__MinimumLevel__Default: "Information"
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```json filename="secrets.json" copy
    {
      "Serilog": {
        "MinimumLevel": {
          "Default": "Information",
          "Override": {
            "Microsoft": "Warning",
            "Microsoft.AspNetCore.Hosting.Diagnostics": "Error",
            "Microsoft.Hosting.Lifetime": "Information"
          }
    }
  },
    }
    ```

  </Tabs.Tab>
</Tabs>

## ASP.NET Core

Since Relay is an ASP.NET Core application, there are some capabilities of that framework that can be configured in the standard way.

Examples of this include [hosting configuration](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel/endpoints) (e.g. bind addresses, TLS...).

Please refer to the [ASP.NET Core documentation](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/) on these topics.
